<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFEM Structural Block Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='colors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ—ï¸</div>
            <div class="logo-text">RFEM <span>Block Generator</span></div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="restartChat()">
                ğŸ”„ Restart
            </button>
        </div>
    </header>

    <main class="main-container">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-status"></div>
                <span>Athena - AI Assistant</span>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">ğŸ—ï¸</div>
                    <h2>Athena - AI Assistant</h2>
                    <p>For RFEM Block Suggester and Generator.<br>Describe a structure to begin.</p>
                    <div class="empty-state-actions">
                        <button class="empty-state-btn" onclick="sendQuickMessage('I need a 2D truss')">ğŸ”º 2D
                            Truss</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('Create a 3D frame')">ğŸ—ï¸ 3D
                            Frame</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('Design a 3D arch bridge')">ğŸŒ‰ Arch
                            Bridge</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('I want a cable-stayed bridge')">ğŸŒ
                            Cable Bridge</button>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Describe what you need..." rows="1"
                        onkeydown="handleKeyDown(event)"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>

        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ¦‰ Athena Database</div>
                <table class="db-stats-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>No.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="stat-icon-small">ğŸ“</span> 2D Blocks</td>
                            <td id="stat2d" class="stat-value">--</td>
                        </tr>
                        <tr>
                            <td><span class="stat-icon-small">ğŸ—ï¸</span> 3D Blocks</td>
                            <td id="stat3d" class="stat-value">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">â„¹ï¸ Status</div>
                <div class="stat-card" style="text-align: left; display: flex; align-items: center; gap: 1rem;">
                    <div class="chat-status" style="width: 12px; height: 12px;"></div>
                    <div>
                        <div style="font-weight: 600;">System Online</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Ready for inputs</div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script>
        const sessionId = 'session_' + Date.now();
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Auto-resize textarea
        chatInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function addMessage(content, type, html = null) {
            // Remove empty state if it exists
            const emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (html) {
                contentDiv.innerHTML = marked.parse(content) + html;
            } else {
                contentDiv.innerHTML = marked.parse(content);
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message message-assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.style.height = 'auto';

            // Show typing indicator
            sendBtn.disabled = true;
            addTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message
                    })
                });

                const data = await response.json();
                removeTypingIndicator();

                // Add all response messages
                for (const msg of data.messages) {
                    addMessage(msg.content, msg.type === 'user' ? 'user' : 'assistant', msg.html || null);
                }

                // Handle parameter input UI
                if (data.ui_elements && data.ui_elements.type === 'parameter_input') {
                    addParameterInput(data.ui_elements);
                }

            } catch (error) {
                removeTypingIndicator();
                addMessage('Sorry, something went wrong. Please try again.', 'assistant');
            }

            sendBtn.disabled = false;
            chatInput.focus();
        }

        function addParameterInput(params) {
            const paramDiv = document.createElement('div');
            paramDiv.className = 'param-input-container';
            paramDiv.id = 'paramInputContainer';
            let placeholderText = "Enter value";
            if (params.param_type === "boolean" || params.param_type === "bool") {
                placeholderText = "Enter true or false";
            }

            paramDiv.innerHTML = `
                <div class="param-header">
                    <span class="param-label">ğŸ“ ${params.label}</span>
                    <span class="param-progress">${params.index} of ${params.total}</span>
                </div>
                <div class="param-input-row">
                    <input type="text" class="param-input" id="paramValue" 
                           placeholder="${placeholderText}"
                           onkeydown="handleParamKeyDown(event)">
                    ${params.unit ? `<span class="param-unit">${params.unit}</span>` : ''}
                </div>
                ${(params.default !== undefined && params.default !== null && params.default !== '') ? `<div class="param-default">Default: ${params.default} ${params.unit ? '[' + params.unit + ']' : ''}</div>` : ''}
            `;

            const lastMessage = chatMessages.lastElementChild;
            if (lastMessage) {
                lastMessage.appendChild(paramDiv);
            }

            document.getElementById('paramValue').focus();
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleParamKeyDown(event) {
            if (event.key === 'Enter') {
                const value = event.target.value;
                const container = document.getElementById('paramInputContainer');
                if (container) container.remove();

                chatInput.value = value;
                sendMessage();
            }
        }

        function sendQuickMessage(message) {
            chatInput.value = message;
            sendMessage();
        }

        async function restartChat() {
            // Restore empty state
            chatMessages.innerHTML = `
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">ğŸ—ï¸</div>
                    <h2>Athena - AI Assistant</h2>
                    <p>For RFEM Block Suggester and Generator.<br>Describe a structure to begin.</p>
                    <div class="empty-state-actions">
                        <button class="empty-state-btn" onclick="sendQuickMessage('I need a 2D truss')">ğŸ”º 2D Truss</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('Create a 3D frame')">ğŸ—ï¸ 3D Frame</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('Design a 3D arch bridge')">ğŸŒ‰ Arch Bridge</button>
                        <button class="empty-state-btn" onclick="sendQuickMessage('I want a cable-stayed bridge')">ğŸŒ Cable Bridge</button>
                    </div>
                </div>
            `;

            try {
                // Call backend to reset session, but ignore the response messages
                // to maintain the clean empty state
                await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: 'restart'
                    })
                });
            } catch (e) {
                console.error("Restart failed", e);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/blocks');
                const data = await response.json();
                document.getElementById('stat2d').textContent = data['2D'].length;
                document.getElementById('stat3d').textContent = data['3D'].length;
            } catch (e) { }
        }

        // Initialize
        loadStats();
        chatInput.focus();

        // Handle block card clicks
        document.addEventListener('click', function (e) {
            if (e.target.closest('.block-card')) {
                const index = e.target.closest('.block-card').dataset.index;
                chatInput.value = index;
                sendMessage();
            }
        });



        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Should show a toast, but for now just console
                console.log('Copied to clipboard');
                // Could also use a temporary tooltip
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
    </script>
</body>

</html>